<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Guitar Tuner (Stable)</title>

    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: white; padding-top: 30px; }

        /* ë²„íŠ¼ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        #startBtn {
            padding: 15px 30px; font-size: 20px; background: #555; color: #aaa;
            border: none; border-radius: 50px; cursor: not-allowed; margin-bottom: 20px;
            transition: all 0.3s;
        }
        #startBtn.ready { background: #007bff; color: white; cursor: pointer; }
        #startBtn:disabled { opacity: 0.7; cursor: wait; }

        .container { max-width: 500px; margin: 0 auto; background: #333; padding: 20px; border-radius: 15px; }
        #note { font-size: 100px; font-weight: bold; margin: 10px 0; color: #fff; }
        #freq { font-size: 24px; color: #aaa; margin-bottom: 20px; }

        .gauge-wrapper { position: relative; width: 100%; height: 30px; background: #444; border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .center-marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #fff; z-index: 2; }
        .needle {
            position: absolute; top: 0; bottom: 0; left: 50%; width: 10px; height: 30px;
            background: #ff4757; border-radius: 5px; transform: translateX(-50%);
            transition: left 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }
        .needle.match { background: #2ecc71; }

        .vol-wrapper { width: 100%; height: 10px; background: #222; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        .vol-bar { width: 0%; height: 100%; background: #00a8ff; transition: width 0.05s; }

        #console {
            margin-top: 20px; padding: 10px; background: #000; color: #0f0;
            font-family: monospace; text-align: left; height: 150px; overflow-y: auto; font-size: 12px;
        }
    </style>
</head>
<body>

    <h1>Web Tuner (Stable)</h1>
    <button id="startBtn" onclick="startTuner()" disabled>â³ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...</button>

    <div class="container">
        <div id="note">--</div>
        <div id="freq">0.0 Hz</div>

        <div class="gauge-wrapper">
            <div class="center-marker"></div>
            <div id="needle" class="needle"></div>
        </div>

        <div style="text-align: left; font-size: 12px; color: #aaa; margin-top: 15px;">Input Level:</div>
        <div class="vol-wrapper">
            <div id="volBar" class="vol-bar"></div>
        </div>
    </div>

    <div id="console">í˜ì´ì§€ ë¡œë“œ ì¤‘...<br></div>

    <script>
        let audioContext;
        let pitch;
        let micStream;
        let analyser;
        let dataArray;
        let isRunning = false;

        function log(msg) {
            const consoleDiv = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML = `[${time}] ${msg}<br>` + consoleDiv.innerHTML;
        }

        // 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬ (í•µì‹¬ ìˆ˜ì • ì‚¬í•­)
        // ml5 ê°ì²´ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ 0.5ì´ˆë§ˆë‹¤ í™•ì¸í•©ë‹ˆë‹¤.
        const checkLibrary = setInterval(() => {
            if (typeof ml5 !== 'undefined') {
                clearInterval(checkLibrary);
                log("âœ… ml5.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ!");
                const btn = document.getElementById('startBtn');
                btn.innerText = "ğŸ¤ ë§ˆì´í¬ ì¼œê¸° & íŠœë‹ ì‹œì‘";
                btn.disabled = false;
                btn.classList.add('ready');
            } else {
                console.log("Waiting for ml5...");
            }
        }, 500);

        // 5ì´ˆ ë’¤ì—ë„ ë¡œë“œê°€ ì•ˆ ë˜ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
        setTimeout(() => {
            if (typeof ml5 === 'undefined') {
                log("âŒ ì˜¤ë¥˜: ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");
                document.getElementById('startBtn').innerText = "ë¡œë”© ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)";
            }
        }, 5000);

        async function startTuner() {
            const btn = document.getElementById('startBtn');
            if (!btn.classList.contains('ready')) return;

            btn.disabled = true;
            btn.innerText = "ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...";

            try {
                log("ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì‹œì‘...");
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                log("ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­...");
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                setupVolumeMeter(micStream);

                log("Pitch ëª¨ë¸(CREPE) ë‹¤ìš´ë¡œë“œ ì‹œì‘...");

                // ëª¨ë¸ ê²½ë¡œ ëª…ì‹œ (0.12.2 ë²„ì „ í˜¸í™˜)
                const modelUrl = 'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/';

                pitch = ml5.pitchDetection(modelUrl, audioContext, micStream, modelLoaded);

            } catch (err) {
                log("âŒ ì—ëŸ¬ ë°œìƒ: " + err.message);
                alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                btn.disabled = false;
                btn.innerText = "ë‹¤ì‹œ ì‹œë„";
            }
        }

        function modelLoaded() {
            log("âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ! íŠœë‹ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
            document.getElementById('startBtn').innerText = "ğŸŸ¢ ì‘ë™ ì¤‘ (ì†Œë¦¬ë¥¼ ë‚´ë³´ì„¸ìš”)";
            isRunning = true;
            getPitch();
        }

        function getPitch() {
            pitch.getPitch(function(err, frequency) {
                if (frequency) {
                    updateUI(frequency);
                }
                if(isRunning) {
                    requestAnimationFrame(getPitch); // ë¶€ë“œëŸ¬ìš´ ë£¨í”„ë¥¼ ìœ„í•´ requestAnimationFrame ì‚¬ìš©
                }
            });
        }

        function updateUI(frequency) {
            const noteElem = document.getElementById('note');
            const freqElem = document.getElementById('freq');
            const needle = document.getElementById('needle');

            freqElem.innerText = frequency.toFixed(1) + ' Hz';

            const midiNum = 12 * (Math.log2(frequency / 440)) + 69;
            const noteIndex = Math.round(midiNum) % 12;
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const note = notes[noteIndex];

            noteElem.innerText = note;

            const targetFreq = 440 * Math.pow(2, (Math.round(midiNum) - 69) / 12);
            const cents = 1200 * Math.log2(frequency / targetFreq);

            let position = 50 + (cents);
            if (position < 5) position = 5;
            if (position > 95) position = 95;

            needle.style.left = position + '%';

            if (Math.abs(cents) < 5) {
                needle.classList.add('match');
            } else {
                needle.classList.remove('match');
            }
        }

        function setupVolumeMeter(stream) {
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVolume();
        }

        function drawVolume() {
            requestAnimationFrame(drawVolume);
            analyser.getByteTimeDomainData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                const x = (dataArray[i] - 128) / 128.0;
                sum += x * x;
            }
            const rms = Math.sqrt(sum / dataArray.length);
            const volBar = document.getElementById('volBar');
            let width = Math.min(rms * 1000, 100);
            volBar.style.width = width + '%';
        }
    </script>
</body>
</html>